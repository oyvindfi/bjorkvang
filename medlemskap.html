<!DOCTYPE html>
<html lang="nb">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medlemskap – Bjørkvang forsamlingslokale</title>
    <link rel="icon" href="images/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a class="skip-link" href="#main-content">Hopp til hovedinnhold</a>
    <header class="site-header">
        <div class="container nav-container">
            <div class="branding">
                <a class="logo" href="/">
                    <span class="logo-mark" aria-hidden="true">BV</span>
                    <span class="logo-text">
                        <span class="logo-title">Bjørkvang forsamlingslokale</span>
                        <span class="logo-subtitle">Helgøens Vel</span>
                    </span>
                </a>
            </div>
            <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-nav">
                <span class="sr-only">Åpne hovedmenyen</span>
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav class="site-nav" id="primary-nav" aria-label="Hovedmeny">
                <ul>
                    <li><a href="/">Hjem</a></li>
                    <li><a href="lokaler.html">Våre lokaler</a></li>
                    <li><a href="booking.html#calendar">Kalender</a></li>
                    <li><a href="booking.html">Lei lokalet</a></li>
                    <li><a href="medlemskap.html" aria-current="page">Medlemskap</a></li>
                    <li><a href="nyheter.html">Nyheter</a></li>
                    <li><a href="kontakt.html">Kontakt</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="page-hero" aria-labelledby="membership-title">
        <div class="container hero-inner">
            <div class="hero-content">
                <span class="hero-eyebrow">Fellesskap</span>
                <h1 id="membership-title">Bli medlem i Helgøens Vel</h1>
                <p>Støtt Bjørkvang med 250 kr i året. Medlemmer får rabatt på leie.</p>
                <div class="hero-actions">
                    <a class="button" href="#betal">Bli medlem nå</a>
                </div>
            </div>
            <figure class="hero-media">
                <img src="images/bjorkvang-vinter.png" alt="Bjørkvang forsamlingslokale i vinterlys">
            </figure>
        </div>
    </section>

    <main class="page-main" id="main-content">
        <section class="page-section">
            <div class="container">
                <div class="section-heading">
                    <h2>Hvorfor bli medlem?</h2>
                    <p>Medlemskontingenten går direkte til drift og videreutvikling av forsamlingshuset vårt.</p>
                </div>
                <ul class="feature-list">
                    <li><strong>Rabatt på leie:</strong> Medlemmer får reduserte priser på leie av lokalet.</li>
                    <li><strong>Støtte til nærmiljøet:</strong> Bidraget ditt gir oss mulighet til å vedlikeholde og utvikle Bjørkvang.</li>
                </ul>
            </div>
        </section>

        <section class="page-section" id="betal">
            <div class="container">
                <div class="vipps-callout" aria-labelledby="vipps-heading">
                    <h2 id="vipps-heading">Bli medlem</h2>
                    <p>Medlemskap koster <strong>250 kr</strong> per år.</p>
                    
                    <div class="vipps-payment-container">
                        <p>Betal enkelt med Vipps for å registrere ditt medlemskap:</p>
                        
                        <button id="vipps-pay-btn" class="button vipps-button">
                            <span class="vipps-icon">V</span>
                            Betal med Vipps
                        </button>
                        <p id="vipps-status" class="form-status" style="display:none; margin-top: 1rem;"></p>
                    </div>

                    <div class="manual-payment-details">
                        <p class="small-text">Alternativt kan du betale manuelt:</p>
                        <ul class="vipps-steps small-text">
                            <li><strong>Vipps-nummer:</strong> #104631 (merk med «Medlemskap»)</li>
                            <li><strong>Konto:</strong> 1822.40.12345 (merk med «Medlemskap»)</li>
                        </ul>
                    </div>
                    
                    <p class="membership-note">Kontingenten gjelder per kalenderår. Velkommen som medlem!</p>
                </div>
            </div>
        </section>

        <script>
            document.getElementById('vipps-pay-btn').addEventListener('click', async () => {
                const btn = document.getElementById('vipps-pay-btn');
                const errorEl = document.getElementById('vipps-error');
                
                btn.disabled = true;
                btn.textContent = 'Laster...';
                errorEl.style.display = 'none';

                try {
                    // Determine API URL based on environment
                    const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                    const apiBase = isLocal ? 'http://localhost:7071' : 'https://bjorkvang-duhsaxahgfe0btgv.westeurope-01.azurewebsites.net';
                    
                    const response = await fetch(`${apiBase}/api/vipps/initiate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({}) 
                    });

                    const data = await response.json();

                    if (response.ok && data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error(data.error || 'Kunne ikke starte Vipps-betaling');
                    }
                } catch (err) {
                    console.error(err);
                    errorEl.textContent = 'Beklager, noe gikk galt. Vennligst prøv manuell betaling.';
                    errorEl.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = '<span class="vipps-icon">V</span> Betal med Vipps';
                }
            });

            // Check for success query param
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('status') === 'success') {
                const container = document.querySelector('.vipps-payment-container');
                if (container) {
                    container.innerHTML = `
                        <div class="success-message" style="text-align: center; color: var(--brand-600);">
                            <h3 style="margin-top:0;">Takk for din betaling!</h3>
                            <p>Ditt medlemskap er nå registrert.</p>
                        </div>
                    `;
                }
            }
        </script>

        <section class="page-section">
            <div class="container">
                <div class="info-grid">
                    <article class="info-card">
                        <h3>Grasrotandelen</h3>
                        <p>Støtt Helgøens Vel via Norsk Tippings Grasrotandel.</p>
                        <p><strong>Org.nr:</strong> 995 519 240</p>
                    </article>
                    <article class="info-card">
                        <h3>Spørsmål?</h3>
                        <p>Kontakt styret hvis du lurer på noe om medlemskap eller betaling.</p>
                        <p><a class="text-link" href="kontakt.html">Kontakt oss</a></p>
                    </article>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container footer-grid">
            <div>
                <h2 class="footer-title">Bjørkvang forsamlingslokale</h2>
                <p>Et inkluderende forsamlingshus på Helgøya som rommer møter, feiringer og fellesskap.</p>
            </div>
            <div>
                <h2 class="footer-title">Snarveier</h2>
                <ul class="footer-links">
                    <li><a href="lokaler.html">Våre lokaler</a></li>
                    <li><a href="booking.html">Lei lokalet</a></li>
                    <li><a href="medlemskap.html" aria-current="page">Medlemskap</a></li>
                    <li><a href="nyheter.html">Nyheter</a></li>
                </ul>
            </div>
            <div>
                <h2 class="footer-title">Kontakt</h2>
                <ul class="footer-contact">
                    <li><a href="mailto:styret@bjørkvang.no">styret@bjørkvang.no</a></li>
                    <li><a href="tel:+4748060273">+47 480 60 273</a></li>
                    <li>Helgøya, Ringsaker</li>
                </ul>
            </div>
        </div>
        <p class="footer-meta">&copy; 2025 Bjørkvang forsamlingslokale og Helgøens Vel.</p>
    </footer>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const payBtn = document.getElementById('vipps-pay-btn');
            const statusEl = document.getElementById('vipps-status');

            // Check for return from Vipps
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            const statusParam = urlParams.get('status');

            if (orderId && statusParam === 'success') {
                statusEl.style.display = 'block';
                statusEl.textContent = 'Sjekker betalingsstatus...';
                statusEl.className = 'form-status'; // Reset class

                try {
                    const response = await fetch('/api/vipps/check-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'AUTHORIZED' || data.status === 'CAPTURED') {
                        statusEl.textContent = 'Takk! Ditt medlemskap er betalt og registrert.';
                        statusEl.className = 'form-status is-success';
                        payBtn.style.display = 'none';
                    } else {
                        statusEl.textContent = 'Betalingen ble ikke fullført. Prøv igjen.';
                        statusEl.className = 'form-status is-error';
                    }
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = 'Kunne ikke verifisere betalingen. Ta kontakt hvis beløpet er trukket.';
                    statusEl.className = 'form-status is-error';
                }
            }

            payBtn.addEventListener('click', async () => {
                payBtn.disabled = true;
                payBtn.textContent = 'Starter Vipps...';
                statusEl.style.display = 'none';

                try {
                    const response = await fetch('/api/vipps/initiate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) throw new Error('Kunne ikke starte betaling');

                    const data = await response.json();
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error('Ingen URL mottatt fra Vipps');
                    }
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = 'Noe gikk galt. Prøv igjen senere.';
                    statusEl.className = 'form-status is-error';
                    statusEl.style.display = 'block';
                    payBtn.disabled = false;
                    payBtn.textContent = 'Betal med Vipps';
                }
            });
        });
    </script>
</body>
</html>